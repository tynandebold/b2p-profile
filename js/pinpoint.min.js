function Pinpoint(t){"use strict";if(null==window.L)throw"Leaflet.js not present on page.";var e=this;this.opts=t,this.opts.el=this.opts.element||this.opts.el||"#map-el",this.element=document.querySelector(this.opts.el),this.opts.basemap=t.basemap||"http://{s}.tile.osm.org/{z}/{x}/{y}.png",this.opts.basemapCredit=t.basemapCredit||'<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> | &copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',this.addElements(),this.fillText(),this.setAspectRatio(),this.setupMap(),this.calcBounds(),this.disableInteraction(),this.opts.creation&&(this.enableInteraction(),this.map.remove(),this.map.setMaxBounds(null),this.setupMap({nozoomlimits:!0})),this.element.querySelector(".map-outer").addEventListener("click",this.enableInteraction.bind(e)),t.minimap&&this.addMinimap();for(var i=0;i<t.markers.length;i++)this.addMarker(t.markers[i],i);t.geojson&&this.addGeoJSON(t.geojson),"undefined"!=typeof Iframe&&Iframe.init(),this.onResize(function(){e.setAspectRatio()})}Pinpoint.prototype.addElements=function(){var t='<!-- Generator: Adobe Illustrator 16.0.1, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="Layer_5" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\t width="13.312px" height="15.267px" viewBox="0 0 13.312 15.267" enable-background="new 0 0 13.312 15.267" xml:space="preserve"><path fill="#697379" d="M13.312,6.4c0.002-1.229-2.215-1.265-2.203,0.008c0,0,0-0.604,0-0.846c0.016-1.146-2.188-1.216-2.2,0.007\tv-0.44c0-1.251-2.307-1.277-2.307,0.007c0,0,0-2.586,0-4.218c0-1.203-2.341-1.246-2.341,0.005v7.485L2.049,6.199\tC1.292,5.286-0.58,6.604,0.177,7.68l5.129,6.233c0,0,1.097,1.354,3.285,1.354c1.963,0,2.704-0.394,3.481-1.2\tc0.754-0.78,1.24-1.657,1.24-2.938C13.312,10.76,13.312,7.192,13.312,6.4z"/></svg>',e='<p class="pinpoint-hed"></p><p class="pinpoint-dek"></p><div class="map-outer inactive"><span class="map-cover"></span><span class="image-interactive-icon">'+t+'<span class="image-interactive-icon-text">Zoom/Pan</span></span><span class="image-interactive-icon image-interactive-icon-hover">'+t.replace("#697379","white")+'<span class="image-interactive-icon-text">Zoom/Pan</span></span><div class="map-inner"></div> </div> <p class="pinpoint-note"></p> <p class="pinpoint-source">'+this.opts.basemapCredit+"</p>";this.element.innerHTML=e},Pinpoint.prototype.setAspectRatio=function(){if(this.element.querySelector(".map-inner")){for(var t={tall:1.2,square:1,wide:2/3},e=t[this.opts["aspect-ratio"]],i=this.element.querySelector(".map-inner").offsetWidth*e,n=this.element.querySelectorAll(".map-inner, .map-cover"),o=0;o<n.length;o++)n[o].style.height=i+"px";this.map&&this.map.invalidateSize()}},Pinpoint.prototype.setupMap=function(t){var e=this.opts,i=e.zoom+1,n=e.zoom-1;t&&t.nozoomlimits&&(i=20,n=1);var o={scrollWheelZoom:!0,keyboard:!1,maxZoom:i,minZoom:n,attributionControl:!1},a=this.element.querySelector(".map-inner");this.map=L.map(a,o).setView([e.lat,e.lon],e.zoom),L.control.scale({position:"topright"}).addTo(this.map);var s=this.element.querySelector(".leaflet-control-scale.leaflet-control"),r=s.querySelector(".leaflet-control-scale-line");s.appendChild(r),L.tileLayer(this.opts.basemap).addTo(this.map),e.dragend&&this.map.on("dragend",e.dragend),e.zoomend&&this.map.on("zoomend",e.zoomend)},Pinpoint.prototype.addMarker=function(t,e){this.markers=this.markers||[],t.icon=t.icon||"circle";var i=L.divIcon({className:"marker-icon marker-icon-"+t.icon}),n=L.marker([t.lat,t.lon],{icon:i,draggable:this.opts.creation,title:e}).addTo(this.map);t.label=t.label||"plain";var o=t["label-direction"]||"north";if("callout"===t.label)var a=L.divIcon({className:"marker-label-callout "+o,html:'<div class="marker-inner">'+t.text+"</div>"});else if("plain"===t.label)var a=L.divIcon({className:"marker-label-plain "+o,html:'<div class="marker-inner">'+t.text+"</div>"});for(var s=L.marker([t.lat,t.lon],{icon:a}).addTo(this.map),r=this.element.querySelectorAll(".marker-inner"),l=0;l<r.length;l++){var p=r[l];p.style.marginLeft=-p.offsetWidth/2+"px",setTimeout(function(){p.style.marginLeft=-p.offsetWidth/2+"px"}.bind(this),100)}this.opts.markerdragend&&n.on("dragend",this.opts.markerdragend),this.markers.push({icon:n,text:s})},Pinpoint.prototype.addMinimap=function(){var t=L.tileLayer(this.opts.basemap,{attribution:""}),e=new L.Control.MiniMap(t,{zoomLevelOffset:this.opts["minimap-zoom-offset"]||-5,width:100,height:100,aimingRectOptions:{color:"black",weight:1,opacity:1,fillColor:"#999",fillOpacity:0}}).addTo(this.map);e._miniMap.dragging.disable(),e._miniMap.touchZoom.disable(),e._miniMap.doubleClickZoom.disable(),e._miniMap.scrollWheelZoom.disable(),e._miniMap.tap&&e._miniMap.tap.disable()},Pinpoint.prototype.calcBounds=function(){function t(t){var e=1/3,i=t.getBounds(),n=Math.abs(i._southWest.lng-i._northEast.lng)*e,o=Math.abs(i._southWest.lat-i._northEast.lat)*e,a={lat:i._southWest.lat-o,lng:i._southWest.lng-n},s={lat:i._northEast.lat+o,lng:i._northEast.lng+n};return L.latLngBounds(a,s)}var e=t(this.map);this.map.setMaxBounds(e)},Pinpoint.prototype.fillText=function(){this.opts.hed&&this.opts.hed.length>0?this.element.querySelector(".pinpoint-hed").innerText=this.opts.hed:this.element.querySelector(".pinpoint-hed").style.display="none",this.opts.dek&&this.opts.dek.length>0?this.element.querySelector(".pinpoint-dek").innerText=this.opts.dek:this.element.querySelector(".pinpoint-dek").style.display="none",this.opts.note&&this.opts.note.length>0?this.element.querySelector(".pinpoint-note").innerHTML=this.opts.note:this.element.querySelector(".pinpoint-note").style.display="none";for(var t=this.element.querySelectorAll(".pinpoint-hed, .pinpoint-dek"),e=0;e<t.length;e++){var i=t[e];i.offsetWidth>0&&i.offsetHeight>0&&(i.className=i.className+" pinpoint-topline")}},Pinpoint.prototype.disableInteraction=function(){return this.map,this.element.querySelector(".map-outer").className+=" inactive",this},Pinpoint.prototype.enableInteraction=function(){var t=(this.map,this.element.querySelector(".map-outer"));return t.className=t.className.replace(/inactive/g,""),this},Pinpoint.prototype.remove=function(){clearInterval(this.resizeInterval),this.map.outerHTML="",this.element.innerHTML=""},Pinpoint.prototype.addGeoJSON=function(t){function e(t,e){for(var i=0;i<e.length;i++)if(e[i]===t)return!0;return!1}for(var i=this.map,n=t.features,o=0;o<n.length;o++)if(n[o].geometry&&n[o].geometry){if(n[o].properties&&n[o].properties.pinpointStyle)var a=n[o].properties.pinpointStyle;else var a="";var s=n[o].geometry.type;e(s,["LineString","MultiLineString","Polygon","MultiPolygon"])&&L.geoJson(n[o].geometry,{style:{className:"pinpoint-geojson "+a}}).addTo(i)}},Pinpoint.prototype.onResize=function(t){var e=this.element.offsetWidth;this.resizeInterval=setInterval(function(){e!==this.element.offsetWidth&&(e=e,t())}.bind(this),50)};